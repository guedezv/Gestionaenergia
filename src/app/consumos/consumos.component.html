<div class="layout">
  <app-header></app-header>

  <div class="layout-main">
    <div class="sidebar-container">
      <app-sidebar></app-sidebar>
    </div>

    <div class="container mt-4 consumos">
      <h2>Consumos</h2>

      <div *ngIf="loading" class="alert alert-info">Cargando consumos…</div>
      <div *ngIf="!loading && error" class="alert alert-danger">{{ error }}</div>

      <!-- Filtros -->
      <div class="filter-block" *ngIf="!loading && !error">
        <label class="filter-title">Filtrar por:</label>

        <div class="filter-line">
          <!-- Texto libre (Swagger: q = Observación) -->
          <input
            type="text"
            class="form-control"
            placeholder="Observación (q)"
            [(ngModel)]="filtroTexto"
            name="filtroTexto"
          />

          <!-- Institución -->
          <select
            class="form-select"
            [(ngModel)]="institucionSeleccionada"
            name="institucion"
            (ngModelChange)="onChangeInstitucion()">
            <option [ngValue]="null">Institución (todas)</option>
            <option *ngFor="let i of instituciones" [ngValue]="i.Id">{{ i.Nombre }}</option>
          </select>

          <!-- Servicio (DivisionId) -->
          <select
            class="form-select"
            [(ngModel)]="servicioSeleccionado"
            name="servicio">
            <option [ngValue]="null">Servicio (todos)</option>
            <option *ngFor="let s of serviciosFiltrados" [ngValue]="s.Id">{{ s.Nombre }}</option>
          </select>

          <!-- Energético -->
          <select
            class="form-select"
            [(ngModel)]="energeticoSeleccionado"
            name="energetico">
            <option [ngValue]="null">Energético (todos)</option>
            <option *ngFor="let e of energeticos" [ngValue]="e.Id">{{ e.Nombre }}</option>
          </select>

          <!-- Nº de cliente -->
          <input
            type="number"
            class="form-control"
            placeholder="N° de cliente"
            [(ngModel)]="numeroClienteId"
            name="numeroClienteId"
            min="0"
          />

          <!-- Fechas -->
          <input
            type="date"
            class="form-control"
            [(ngModel)]="fechaDesde"
            name="fechaDesde"
            [max]="fechaHasta || undefined"
            placeholder="Desde"
          />

          <input
            type="date"
            class="form-control"
            [(ngModel)]="fechaHasta"
            name="fechaHasta"
            [min]="fechaDesde || undefined"
            placeholder="Hasta"
          />

          <button class="btn btn-primary btn-filter" type="button" (click)="aplicarFiltro()">
            Filtrar
          </button>
        </div>
      </div>

      <!-- Encabezados + separador -->
      <div class="header-row" *ngIf="!loading && !error">
        <span class="col-id">ID</span>
        <span>Inicio de lectura</span>
        <span class="col-wide">Unidad</span>
        <span>Energético</span>
        <span>N° de cliente</span>
        <span>Revisado por</span>
        <span>Estado</span>
      </div>
      <hr class="separator" *ngIf="!loading && !error" />

      <!-- Tabla -->
      <table class="table table-clean zebra" *ngIf="!loading && !error">
        <tbody>
          <tr *ngFor="let c of compras; let i = index" [class.alt]="i % 2 === 1">
            <td class="col-id"><div class="row-chip">{{ c.Id }}</div></td>

            <td><div class="row-chip">{{ fecha(c.InicioLectura) || '—' }}</div></td>

            <td class="col-wide">
              <div class="row-chip">
                {{ c.UnidadNombre || ('División #' + (c.DivisionId ?? '—')) }}
              </div>
            </td>

            <td>
              <div class="row-chip">{{ energeticoNombre(c.EnergeticoId) }}</div>
            </td>

            <td>
              <div class="row-chip">{{ c.NumeroClienteId || '—' }}</div>
            </td>

            <td>
              <div class="row-chip">{{ c.RevisadoPor || '—' }}</div>
            </td>

            <td>
              <div class="row-chip estado">
                <span class="badge" [class.ok]="c.Active" [class.off]="!c.Active">
                  {{ c.Active ? 'OK' : 'Inactivo' }}
                </span>
              </div>
            </td>
          </tr>

          <tr *ngIf="compras?.length === 0">
            <td colspan="7" class="empty">No hay consumos para mostrar.</td>
          </tr>
        </tbody>
      </table>

      <!-- Paginación -->
      <nav *ngIf="!loading && totalPaginas > 1" class="paginacion">
        <ul class="pagination">
          <li class="page-item" [class.disabled]="pagina === 1">
            <button class="page-link" title="Primera" (click)="irPrimera()">«</button>
          </li>
          <li class="page-item" [class.disabled]="pagina === 1">
            <button class="page-link" title="Anterior" (click)="irA(pagina - 1)">‹</button>
          </li>

          <li
            class="page-item"
            *ngFor="let p of getPaginasArray()"
            [class.active]="pagina === p">
            <button class="page-link" (click)="irA(p)">{{ p }}</button>
          </li>

          <li class="page-item" [class.disabled]="pagina === totalPaginas">
            <button class="page-link" title="Siguiente" (click)="irA(pagina + 1)">›</button>
          </li>
          <li class="page-item" [class.disabled]="pagina === totalPaginas">
            <button class="page-link" title="Última" (click)="irUltima()">»</button>
          </li>
        </ul>
      </nav>

      <div class="bottom-actions" *ngIf="!loading && !error">
        <button class="btn btn-secondary" type="button" (click)="volver()">Volver</button>
      </div>
    </div>
  </div>

  <app-footer></app-footer>
</div>
